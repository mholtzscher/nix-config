# Guacamole Architecture on NixOS

## Component Overview

```
┌─────────────────────────────────────────────────────────────┐
│                     End User                                │
│                   (Web Browser)                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                    HTTPS (443)
                         │
         ┌───────────────────────────────────┐
         │   Reverse Proxy (Caddy/Nginx)    │
         │   (Optional but recommended)      │
         └────────────────┬──────────────────┘
                         │
                      HTTP (8080)
                         │
         ┌───────────────────────────────────┐
         │   Apache Tomcat                   │
         │   ├─ guacamole-client.war         │
         │   └─ Web UI & Management          │
         └────────────────┬──────────────────┘
                         │
              TCP (4822 local)
                         │
         ┌───────────────────────────────────┐
         │   guacd (Guacamole Server)        │
         │   ├─ Protocol handlers            │
         │   │  ├─ RDP                       │
         │   │  ├─ VNC                       │
         │   │  ├─ SSH                       │
         │   │  └─ Telnet                    │
         │   └─ Connection Management        │
         └────────────────┬──────────────────┘
                         │
   ┌─────────────┬───────┴───────┬──────────────┐
   │             │               │              │
   ▼             ▼               ▼              ▼
 RDP         VNC            SSH           Telnet
Server      Server        Server         Server
(3389)      (5900)        (22)          (23)
```

## Service Dependencies

### Startup Order

1. **Network target** (`network.target`)
   - Required by: all other services

2. **guacamole-server** (guacd daemon)
   - Depends on: `network.target`
   - Provides: Local socket on port 4822

3. **Tomcat** (web container)
   - Depends on: `guacamole-server` (if on same host)
   - Provides: HTTP service on port 8080

4. **Reverse Proxy** (Caddy/Nginx) [Optional]
   - Depends on: `tomcat`
   - Provides: HTTPS on port 443, HTTP on port 80

### Systemd Service Configuration

#### guacamole-server Service

```ini
[Unit]
Description=Apache Guacamole server (guacd)
After=network.target

[Service]
ExecStart=/nix/store/.../bin/guacd -f -b 127.0.0.1 -l 4822
RuntimeDirectory=guacamole-server
DynamicUser=yes
PrivateTmp=yes
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

**Key properties**:
- **DynamicUser=yes**: Creates temporary unprivileged user
- **PrivateTmp=yes**: Isolated temporary directory
- **Restart=on-failure**: Auto-recovers from crashes

#### Tomcat Service

```ini
[Unit]
Description=Apache Tomcat Web Application Server
After=network.target

[Service]
Type=simple
ExecStart=/nix/store/.../bin/catalina.sh run
User=tomcat
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

## Configuration Files

### Generated by NixOS

**guacamole.properties** (auto-generated from settings)
- **Location**: `/etc/guacamole/guacamole.properties`
- **Format**: Java properties format (key=value)
- **Permissions**: World readable
- **Regenerated**: On every rebuild

```
# Generated from services.guacamole-client.settings
guacd-hostname=localhost
guacd-port=4822
log4j.rootCategory=INFO
```

### User-Supplied Configuration

**user-mapping.xml** (if provided)
- **Location**: `/etc/guacamole/user-mapping.xml`
- **Format**: XML with user definitions
- **Permissions**: World readable
- **Source**: Specified in `services.guacamole-server.userMappingXml`

```xml
<user-mapping>
  <authorize username="admin" password="admin">
    <connection name="rdp-server">
      <protocol>rdp</protocol>
      <param name="hostname">10.0.0.5</param>
      <param name="port">3389</param>
    </connection>
  </authorize>
</user-mapping>
```

### Optional Logging Configuration

**logback.xml** (if provided)
- **Location**: `/etc/guacamole/logback.xml`
- **Format**: Logback XML configuration
- **Source**: Specified in `services.guacamole-server.logbackXml`

## Data Flow

### Connection Establishment

1. **User requests connection**
   - Browser -> Tomcat (HTTP POST)
   - URL: `/guacamole/api/connections/{connection-id}/connect`

2. **Tomcat authenticates user**
   - Checks user-mapping.xml OR database
   - Returns connection parameters

3. **Tomcat connects to guacd**
   - Tomcat -> guacd (TCP on port 4822)
   - Sends connection parameters via Guacamole protocol

4. **guacd connects to backend**
   - guacd -> RDP/VNC/SSH/Telnet server
   - Establishes protocol connection

5. **Bidirectional tunnel established**
   - Browser <-> Tomcat <-> guacd <-> Backend Server
   - All data flows through Guacamole protocol (binary)

### Desktop Rendering

```
Backend Server → guacd → Tomcat → Browser
(screen update)  (protocol (HTTP    (WebSocket/
                 handler) chunks)   HTTP stream)
```

1. Backend server sends screen updates
2. guacd processes and compresses via Guacamole protocol
3. Tomcat streams to browser (chunked HTTP)
4. Browser JavaScript renders in canvas or virtual display

## Network Requirements

### Incoming Traffic

| Source | Destination | Port | Protocol | Purpose |
|--------|-------------|------|----------|---------|
| Internet | Firewall | 443 | HTTPS | User browser to reverse proxy |
| Internet | Firewall | 80 | HTTP | User browser to reverse proxy (redirect) |
| Local LAN | NixOS Host | 8080 | HTTP | Reverse proxy to Tomcat (if local) |

### Outgoing Traffic

| Source | Destination | Port | Protocol | Purpose |
|--------|-------------|------|----------|---------|
| NixOS Host | RDP Servers | 3389 | RDP | Backend RDP connections |
| NixOS Host | VNC Servers | 5900+ | VNC | Backend VNC connections |
| NixOS Host | SSH Servers | 22 | SSH | Backend SSH connections |
| NixOS Host | Telnet | 23 | Telnet | Backend Telnet connections |

### Local Communication

| Source | Destination | Port | Protocol | Purpose |
|--------|-------------|------|----------|---------|
| Tomcat | guacd | 4822 | TCP | Guacamole protocol |
| (Optional) Reverse Proxy | Tomcat | 8080 | HTTP | Web content |

## High-Level Connection Flow Example

```
User opens browser
  ↓
browser → https://guacamole.example.com
  ↓
Reverse Proxy (Caddy)
  ├─ Terminates SSL/TLS
  ├─ Routes to http://localhost:8080
  └─ Forwards request
  ↓
Tomcat (Java servlet container)
  ├─ Authenticates user (user-mapping.xml)
  ├─ Validates permissions
  └─ Connects to guacd on localhost:4822
  ↓
guacd (C daemon)
  ├─ Receives connection parameters
  ├─ Initiates RDP/VNC/SSH/Telnet connection
  └─ Bridges protocols
  ↓
Backend Server (RDP/VNC/SSH)
  ├─ Receives connection request
  ├─ Authenticates
  └─ Sends desktop/terminal stream
  ↓
guacd processes and compresses data
  ↓
Tomcat receives compressed stream via Guacamole protocol
  ↓
Browser receives HTTP/WebSocket stream
  ↓
JavaScript client renders in browser
  ↓
User sees desktop/terminal in web interface
```

## Storage & Persistence

### Runtime Data

- **guacd runtime**: `/run/guacamole-server/` (cleaned on reboot)
- **Tomcat runtime**: `/run/tomcat/` (cleaned on reboot)
- **Session data**: Memory-only by default

### Configuration

- **guacamole.properties**: `/etc/guacamole/guacamole.properties`
- **user-mapping.xml**: `/etc/guacamole/user-mapping.xml`
- **logback.xml**: `/etc/guacamole/logback.xml`

All configuration is:
- Read-only in /etc
- Managed by NixOS
- Regenerated on rebuild
- No persistent modification possible

### Database (if configured)

- Location: Depends on database service
- Examples:
  - MySQL: `/var/lib/mysql/`
  - PostgreSQL: `/var/lib/postgresql/`
  - File: Location specified in configuration

## Security Boundaries

### Privilege Separation

| Component | User | Capabilities | Purpose |
|-----------|------|--------------|---------|
| guacd | Dynamic (unprivileged) | Network access only | Handles remote connections |
| Tomcat | tomcat | Network access only | Web application |
| Caddy | caddy | Can bind port 80/443 | Reverse proxy |

### Isolation

- **guacd**: Private /tmp via `PrivateTmp=yes`
- **Tomcat**: Standard Java sandbox
- **Network**: guacd only connects to configured hosts

### Configuration Access

- All config files readable by unprivileged users
- **IMPORTANT**: Passwords in user-mapping.xml are plaintext!
- **Recommendation**: Use database auth or SSH keys instead

## Performance Considerations

### Memory Usage

- **guacd**: Minimal per connection (~5-10 MB)
- **Tomcat**: Base ~200-300 MB + per-session overhead
- **Browser**: JavaScript client ~50-100 MB

### Compression & Optimization

- Guacamole protocol: Binary, compressed
- Display cache: Improves performance for static screens
- Bandwidth: ~100 KB/s typical for normal usage

### Scaling Strategies

1. **Vertical**: Increase `-Xmx` Java heap size
2. **Horizontal**: Multiple Guacamole instances with load balancer
3. **Separation**: guacd on separate host from Tomcat
